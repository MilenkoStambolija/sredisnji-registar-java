<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SREDIŠNJI REGISTAR STANOVNIŠTVA (Java)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        html {
            scroll-behavior: smooth;
        }
        body { font-family: 'Inter', sans-serif; }
        #graph-container {
            width: 100%;
            height: 600px;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: #f9fafb;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #3b82f6; border-radius: 50%;
            width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        th, td { padding: 0.75rem; text-align: left; font-size: 0.875rem; }
        thead th { background-color: #f3f4f6; color: #4b5563; }
        tbody tr:nth-child(even) { background-color: #f9fafb; }

        .nav-link {
            padding: 0.75rem 1rem; border-radius: 0.375rem; cursor: pointer;
            transition: all 0.2s ease-in-out; font-weight: 600;
            color: #374151; background-color: #e5e7eb; text-decoration: none;
        }
        .nav-link:hover { background-color: #d1d5db; color: #1d4ed8; }
        .nav-link:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            box-shadow: 0 0 0 2px #2563eb;
        }
        #section-table, #section-graph, #section-queries {
            padding-top: 10px;
        }
        .filter-input {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
            gap: 1rem;
        }
        .info-card {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }
        .info-card h4 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #475569;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .info-card p {
            margin: 0;
            font-size: 1rem;
            font-weight: 500;
            color: #0f172a;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">
<div class="container mx-auto max-w-6xl bg-white p-6 md:p-8 rounded-lg shadow-xl">
    <header class="mb-8 text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-blue-700">SREDIŠNJI REGISTAR STANOVNIŠTVA</h1>
        <p class="text-gray-600 mt-2">Pretraga veza po OIB-u od 10000000001 do 10000000117 (Java Backend)</p>
    </header>

    <section class="mb-8">
        <form id="search-form" class="flex flex-col sm:flex-row items-center gap-4">
            <label for="oib-input" class="sr-only">Unesite OIB:</label>
            <input type="text" id="oib-input" name="oib" placeholder="Unesite OIB (11 znamenki)"
                   class="flex-grow p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg"
                   pattern="\d{11}" title="OIB mora sadržavati točno 11 znamenki." required>
            <button type="submit"
                    class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md shadow-md transition duration-150 ease-in-out text-lg">
                Pretraži
            </button>
        </form>
        <div id="loading-indicator" class="loader" style="display: none;"></div>
        <div id="error-message" class="mt-4 p-3 bg-red-100 text-red-700 border border-red-300 rounded-md" style="display: none;"></div>
    </section>

    <section id="results-section" class="mt-8" style="display: none;">
        <h2 class="text-2xl font-semibold mb-1">Rezultati pretrage za OIB: <span id="searched-oib" class="text-blue-600"></span></h2>

        <div id="basic-info-section" class="mb-6 p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
            <h3 class="text-xl font-semibold mb-4 text-gray-700">Osnovni podaci osobe:</h3>
            <div class="info-grid">
                <div class="info-card">
                    <h4>Ime i prezime</h4>
                    <p id="info-puno-ime">-</p>
                </div>
                <div class="info-card">
                    <h4>Spol</h4>
                    <p id="info-spol">-</p>
                </div>
                <div class="info-card">
                    <h4>Datum rođenja</h4>
                    <p id="info-datum-rodjenja">-</p>
                </div>
                <div class="info-card" id="info-datum-smrti-container" style="display: none;">
                    <h4>Datum smrti</h4>
                    <p id="info-datum-smrti">-</p>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <nav class="flex flex-wrap space-x-2 sm:space-x-4 p-1 bg-slate-200 rounded-lg shadow" aria-label="NavigacijaSadrzaja">
                <a href="#section-table" class="nav-link flex-auto sm:flex-1 text-center">Tablični prikaz</a>
                <a href="#section-graph" class="nav-link flex-auto sm:flex-1 text-center">Grafički prikaz</a>
                <a href="#section-queries" class="nav-link flex-auto sm:flex-1 text-center">Opis Operacija / Upiti</a>
            </nav>
        </div>

        <section id="section-table" class="mb-8 p-4 bg-gray-50 rounded-md shadow">
            <h3 class="text-xl font-semibold mb-4 text-gray-700">Pronađene veze:</h3>
            <div class="overflow-x-auto">
                <table id="relationships-table" class="min-w-full divide-y divide-gray-300 border border-gray-300 rounded-md">
                    <thead class="bg-gray-200">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">OIB Povezane Osobe</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Ime i Prezime</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Vrsta Veze</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Tip</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Linija</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Stupanj</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Opis</th>
                    </tr>
                    <tr id="filter-row" class="bg-gray-100">
                        <th class="p-1"><input type="text" data-property="oibPovezaneOsobe" class="filter-input w-full text-sm p-1 border border-gray-300 rounded" placeholder="Filtriraj..."></th>
                        <th class="p-1"><input type="text" data-property="imePrezimePovezaneOsobe" class="filter-input w-full text-sm p-1 border border-gray-300 rounded" placeholder="Filtriraj..."></th>
                        <th class="p-1"><input type="text" data-property="vrstaVezePrikaz" class="filter-input w-full text-sm p-1 border border-gray-300 rounded" placeholder="Filtriraj..."></th>
                        <th class="p-1"><input type="text" data-property="tipVeze" class="filter-input w-full text-sm p-1 border border-gray-300 rounded" placeholder="Filtriraj..."></th>
                        <th class="p-1"><input type="text" data-property="linija" class="filter-input w-full text-sm p-1 border border-gray-300 rounded" placeholder="Filtriraj..."></th>
                        <th class="p-1"><input type="text" data-property="stupanj" class="filter-input w-full text-sm p-1 border border-gray-300 rounded" placeholder="Filtriraj..."></th>
                        <th class="p-1"><input type="text" data-property="opis" class="filter-input w-full text-sm p-1 border border-gray-300 rounded" placeholder="Filtriraj..."></th>
                    </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <p id="no-relationships-message" class="mt-4 text-gray-600" style="display: none;">Nema pronađenih veza za traženi OIB.</p>
        </section>

        <section id="section-graph" class="mb-8 p-1">
            <h3 class="text-xl font-semibold mb-4 text-gray-700">Grafički prikaz veza:</h3>
            <div id="graph-container"></div>
            <p id="no-graph-message" class="mt-4 text-gray-600" style="display: none;">Nema podataka za grafički prikaz.</p>
        </section>

        <section id="section-queries" class="mb-8 p-4 bg-gray-50 rounded-md shadow">
            <h3 class="text-xl font-semibold mb-4 text-gray-700">Opis Operacija / Simulirani Upiti:</h3>
            <pre id="queries-log" class="bg-gray-800 text-green-300 p-4 rounded-md overflow-x-auto text-sm whitespace-pre-wrap max-h-96"></pre>
        </section>
    </section>
</div>

<script>
    const searchForm = document.getElementById('search-form');
    const oibInput = document.getElementById('oib-input');
    const resultsSection = document.getElementById('results-section');
    const searchedOibSpan = document.getElementById('searched-oib');
    const relationshipsTableBody = document.querySelector('#relationships-table tbody');
    const queriesLogPre = document.getElementById('queries-log');
    const graphContainer = document.getElementById('graph-container');
    const errorMessageDiv = document.getElementById('error-message');
    const loadingIndicator = document.getElementById('loading-indicator');
    const noRelationshipsMessage = document.getElementById('no-relationships-message');
    const noGraphMessage = document.getElementById('no-graph-message');

    const basicInfoSection = document.getElementById('basic-info-section');
    const infoPunoIme = document.getElementById('info-puno-ime');
    const infoSpol = document.getElementById('info-spol');
    const infoDatumRodjenja = document.getElementById('info-datum-rodjenja');
    const infoDatumSmrtiContainer = document.getElementById('info-datum-smrti-container');
    const infoDatumSmrti = document.getElementById('info-datum-smrti');

    let allFetchedRelationships = [];
    let currentGraphNodes = [];
    let currentGraphEdges = [];
    let lastSearchedOibData = null;
    let network = null;

    function getActiveFilters() {
        const activeFilters = {};
        document.querySelectorAll('#filter-row .filter-input').forEach(input => {
            const property = input.dataset.property;
            const value = input.value.trim().toLowerCase();
            if (value) {
                activeFilters[property] = value;
            }
        });
        return activeFilters;
    }

    function populateRelationshipsTable(relationshipsToDisplay) {
        relationshipsTableBody.innerHTML = '';
        if (relationshipsToDisplay && relationshipsToDisplay.length > 0) {
            noRelationshipsMessage.style.display = 'none';
            relationshipsToDisplay.forEach(rel => {
                const row = relationshipsTableBody.insertRow();
                row.insertCell().textContent = rel.oibPovezaneOsobe || 'N/A';
                row.insertCell().textContent = rel.imePrezimePovezaneOsobe || 'N/A';
                row.insertCell().textContent = rel.vrstaVezePrikaz || 'N/A';
                row.insertCell().textContent = rel.tipVeze || 'N/A';
                row.insertCell().textContent = rel.linija || 'N/A';
                row.insertCell().textContent = rel.stupanj || 'N/A';
                row.insertCell().textContent = rel.opis || 'N/A';
            });
        } else {
            const activeFilters = getActiveFilters();
            if (Object.keys(activeFilters).length > 0) {
                noRelationshipsMessage.textContent = 'Nema podataka koji odgovaraju trenutnim filterima.';
            } else {
                noRelationshipsMessage.textContent = 'Nema pronađenih veza za traženi OIB.';
            }
            noRelationshipsMessage.style.display = 'block';
        }
    }

    function applyTableFilters() {
        const filterValues = getActiveFilters();
        let dataToDisplay;

        if (Object.keys(filterValues).length === 0) {
            dataToDisplay = [...allFetchedRelationships];
        } else {
            dataToDisplay = allFetchedRelationships.filter(rel => {
                for (const property in filterValues) {
                    const relValue = String(rel[property] || '').toLowerCase();
                    const filterText = filterValues[property];
                    if (!relValue.includes(filterText)) {
                        return false;
                    }
                }
                return true;
            });
        }

        const sortOrder = {
            "Uspravna": 1, "Pobočna": 2, "Partnerska": 3
        };
        dataToDisplay.sort((a, b) => {
            const linijaA = a.linija || ""; const linijaB = b.linija || "";
            const orderA = sortOrder[linijaA] || 99; const orderB = sortOrder[linijaB] || 99;
            if (orderA !== orderB) return orderA - orderB;

            const stupanjA = parseInt(a.stupanj, 10); const stupanjB = parseInt(b.stupanj, 10);
            const valA = isNaN(stupanjA) ? Infinity : stupanjA; const valB = isNaN(stupanjB) ? Infinity : stupanjB;
            if (valA !== valB) return valA - valB;

            const vrstaVezeA = a.vrstaVezePrikaz || ""; const vrstaVezeB = b.vrstaVezePrikaz || "";
            return vrstaVezeA.localeCompare(vrstaVezeB);
        });
        populateRelationshipsTable(dataToDisplay);
    }

    document.querySelectorAll('#filter-row .filter-input').forEach(input => {
        input.addEventListener('input', applyTableFilters);
    });

    function displayGraph() {
        if (network) {
            network.destroy();
            network = null;
        }
        graphContainer.innerHTML = '';

        if (currentGraphNodes && currentGraphNodes.length > 0) {
            noGraphMessage.style.display = 'none';
            const nodes = new vis.DataSet(currentGraphNodes);
            const edges = new vis.DataSet(currentGraphEdges);
            const graphData = { nodes: nodes, edges: edges };
            const options = {
                layout: { hierarchical: false },
                nodes: {
                    shape: 'box',
                    margin: 10,
                    font: { size: 12, color: '#333' },
                    borderWidth: 1,
                    color: {
                        border: '#cccccc',
                        background: '#ffffff',
                        highlight: { border: '#2563eb', background: '#bfdbfe' }
                    }
                },
                edges: {
                    arrows: 'to', smooth: { type: 'cubicBezier', roundness: 0.4 },
                    font: { size: 10, align: 'middle' },
                    color: { color: '#848484', highlight: '#848484', hover: '#2B7CE9' }
                },
                physics: { enabled: true, barnesHut: { gravitationalConstant: -6000, centralGravity: 0.1, springLength: 150, springConstant: 0.05, damping: 0.09 }, solver: 'barnesHut'},
                interaction: { hover: true, tooltipDelay: 200, navigationButtons: true, keyboard: true },
                groups: {
                    M: {
                        color: { background: '#e0f2fe', border: '#7dd3fc' },
                        shape: 'ellipse',
                        highlight: { border: '#3b82f6', background: '#dbeafe' }
                    },
                    Ž: {
                        color: { background: '#fce7f3', border: '#f9a8d4' },
                        shape: 'ellipse',
                        highlight: { border: '#ec4899', background: '#fbcfe8' }
                    },
                    N: {
                        color: { background: '#f3f4f6', border: '#d1d5db' },
                        shape: 'ellipse',
                        highlight: { border: '#6b7280', background: '#e5e7eb' }
                    }
                }
            };
            network = new vis.Network(graphContainer, graphData, options);
            setTimeout(() => {
                if (graphContainer.offsetParent !== null && network && network.body.nodes && Object.keys(network.body.nodes).length > 0) {
                    network.fit();
                }
            }, 50);
        } else if (lastSearchedOibData) {
            noGraphMessage.textContent = 'Nema podataka za grafički prikaz.';
            noGraphMessage.style.display = 'block';
        }
    }

    function parseNodeDetails(node, searchedOib) {
        const details = {
            punoIme: 'Nepoznato',
            spol: 'Nepoznato',
            datumRodjenja: 'Nepoznato',
            datumSmrti: '' // Inicijalno prazan string
        };

        if (!node) return details;

        if (node.label) {
            const labelLines = node.label.split('\n');
            let imeIzLabel = labelLines[0].trim();
            const oibInLabelPattern = `(<span class="math-inline">\{searchedOib\.replace\(/\[\.\*\+?^</span>{}()|[\]\\]/g, '\\$&')})`;
            const regex = new RegExp(`\\s*<span class="math-inline">\{oibInLabelPattern\}\\\\s\*</span>`);
            imeIzLabel = imeIzLabel.replace(regex, '').trim();

            if (imeIzLabel === "" || imeIzLabel === searchedOib) {
                details.punoIme = 'Nepoznato';
            } else {
                details.punoIme = imeIzLabel;
            }
        }

        if (node.title) {
            const titleLines = node.title.split('<br>');
            titleLines.forEach(line => {
                line = line.trim();
                if (line.startsWith("Ime i Prezime: ")) {
                    let imePrezimeFromTitle = line.substring("Ime i Prezime: ".length).trim();
                    if (details.punoIme === 'Nepoznato' && imePrezimeFromTitle !== 'Nepoznato' && imePrezimeFromTitle !== '') {
                        details.punoIme = imePrezimeFromTitle;
                    }
                } else if (line.startsWith("Spol: ")) {
                    details.spol = line.substring("Spol: ".length).trim() || 'Nepoznato';
                } else if (line.startsWith("Rođen: ")) {
                    details.datumRodjenja = line.substring("Rođen: ".length).trim() || 'Nepoznato';
                } else if (line.startsWith("Umro: ")) {
                    details.datumSmrti = line.substring("Umro: ".length).trim();
                }
            });
        }
        return details;
    }


    searchForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        const oibOriginal = oibInput.value;
        const oib = oibOriginal.trim();

        if (!/^\d{11}$/.test(oib)) {
            errorMessageDiv.textContent = 'OIB mora sadržavati točno 11 znamenki.';
            errorMessageDiv.style.display = 'block';
            resultsSection.style.display = 'none';
            return;
        }

        errorMessageDiv.style.display = 'none';
        resultsSection.style.display = 'none';
        loadingIndicator.style.display = 'block';
        noRelationshipsMessage.style.display = 'none';
        noGraphMessage.style.display = 'none';

        document.querySelectorAll('#filter-row .filter-input').forEach(input => {
            input.value = '';
        });

        infoPunoIme.textContent = '-';
        infoSpol.textContent = '-';
        infoDatumRodjenja.textContent = '-';
        infoDatumSmrti.textContent = '-';
        infoDatumSmrtiContainer.style.display = 'none';

        try {
            const response = await fetch('/api/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', },
                body: `oib=${encodeURIComponent(oib)}`
            });

            loadingIndicator.style.display = 'none';
            const data = await response.json();
            console.log("KOMPLETAN ODGOVOR OD SERVERA (data):", JSON.stringify(data, null, 2));

            if (!response.ok) {
                errorMessageDiv.textContent = data.error || `Greška: ${response.status} ${response.statusText}`;
                errorMessageDiv.style.display = 'block';
                resultsSection.style.display = 'none';
                return;
            }

            lastSearchedOibData = data;
            allFetchedRelationships = data.relationships || [];
            currentGraphNodes = data.graph_nodes || [];
            currentGraphEdges = data.graph_edges || [];

            resultsSection.style.display = 'block';
            searchedOibSpan.textContent = data.oib;

            const targetNodeInGraph = currentGraphNodes.find(node => node.id === data.oib);

            if (targetNodeInGraph) {
                console.log("Pronađen targetNodeInGraph:", JSON.stringify(targetNodeInGraph, null, 2));
                const details = parseNodeDetails(targetNodeInGraph, data.oib);
                console.log("Parsirani detalji za osnovni prikaz:", JSON.stringify(details, null, 2));

                infoPunoIme.textContent = details.punoIme !== 'Nepoznato' && details.punoIme.trim() !== '' ? details.punoIme : '-';
                infoSpol.textContent = details.spol !== 'Nepoznato' && details.spol.trim() !== '' ? details.spol : '-';
                infoDatumRodjenja.textContent = details.datumRodjenja !== 'Nepoznato' && details.datumRodjenja.trim() !== '' ? details.datumRodjenja : '-';

                let deathDateString = details.datumSmrti;
                let showDeathCard = false;

                if (typeof deathDateString === 'string') {
                    let trimmedDeathDate = deathDateString.trim();
                    if (trimmedDeathDate !== '' &&
                        trimmedDeathDate.toLowerCase() !== 'null' &&
                        trimmedDeathDate.toLowerCase() !== 'n/a' &&
                        trimmedDeathDate.toLowerCase() !== 'nepoznato') {
                        infoDatumSmrti.textContent = trimmedDeathDate;
                        showDeathCard = true;
                    }
                }

                if (showDeathCard) {
                    infoDatumSmrtiContainer.style.display = 'block';
                } else {
                    infoDatumSmrti.textContent = '-';
                    infoDatumSmrtiContainer.style.display = 'none';
                }
            } else {
                console.warn("Glavni čvor za OIB", data.oib, "nije pronađen u data.graph_nodes. Osnovni podaci ostaju placeholderi.");
                infoPunoIme.textContent = '-';
                infoSpol.textContent = '-';
                infoDatumRodjenja.textContent = '-';
                infoDatumSmrtiContainer.style.display = 'none';
            }

            applyTableFilters();
            displayGraph();
            queriesLogPre.textContent = data.queries_log ? data.queries_log.join('\n\n') : 'Nema zabilježenih upita.';

        } catch (error) {
            console.error('Greška pri pretrazi:', error);
            loadingIndicator.style.display = 'none';
            errorMessageDiv.textContent = 'Dogodila se greška prilikom komunikacije sa serverom: ' + error.message;
            errorMessageDiv.style.display = 'block';
            resultsSection.style.display = 'none';
            infoPunoIme.textContent = '-';
            infoSpol.textContent = '-';
            infoDatumRodjenja.textContent = '-';
            infoDatumSmrti.textContent = '-';
            infoDatumSmrtiContainer.style.display = 'none';
        }
    });
</script>
</body>
</html>